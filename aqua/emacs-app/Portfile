# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 85465 2011-10-14 01:28:06Z dports@macports.org $

PortSystem 1.0

name		emacs-app
version		23.3
revision	3
categories	aqua editors
license		GPL-3+
maintainers	css
description	The GNU Emacs text editor (Cocoa version)

long_description	GNU Emacs is a self-documenting, customizable,      \
	extensible real-time display editor. This is a port of the latest   \
	GNU Emacs source to the OpenStep (or NeXTstep) APIs, as implemented \
	by Cocoa on OS X. It differs from Carbon ports of GNU Emacs in that \
	it makes a more concerted attempt from the ground up to follow OS X \
	desktop and UI conventions.

# Note that this distribution can support GNUstep as well, but that
# configuration is untested at this time.

platforms	darwin
homepage	http://www.gnu.org/software/emacs/
master_sites	gnu:emacs
distname	emacs-${version}a
worksrcdir	emacs-${version}
use_bzip2	yes
checksums           md5     f2cf8dc6f28f8ae59bc695b4ddda339c \
                    sha1    795bdfa372e42b9589a80f6dcb2ad8fed65b90e4 \
                    rmd160  21f201714bca420c3a8fed8c92058cec786e724e

depends_lib     port:ncurses
use_parallel_build      yes

configure.args	--with-ns --without-x --without-dbus

patchfiles      patch-src_emacs.c.diff \
                patch-src_unexmacosx.c.diff \
		patch-font-average_width.diff

if {${configure.compiler} == "clang"} {
    patchfiles-append   patch-clang.diff
}

variant fullscreen description {Add fullscreen patch from http://gist.github.com/291150 as mentioned in http://www.sanityinc.com/full-screen-support-for-cocoa-emacs-on-osx} {
    patchfiles-append patch-fullscreen.diff
}

# inline and font patches are fetched from MacEmacsJP http://svn.sourceforge.jp/svnroot/macemacsjp/inline_patch/trunk/, revision 574.
# patch-macemacsjp-inline.diff <= emacs-inline.patch
# patch-macemacsjp-jpfont.diff <= font.patch

variant inline description {Add inline patch from MacEmacsJP} {
    patchfiles-append patch-macemacsjp-inline.diff
}

variant jpfont description {Add Japanese font patch from MacEmacsJP} {
    patchfiles-append patch-macemacsjp-jpfont.diff
}

variant patches conflicts fullscreen inline jpfont description {Add all patches: fullscreen, inline and jpfont} {
    patchfiles-append patch-fullscreen.diff \
                      patch-macemacsjp-jpfont.diff \
                      patch-macemacsjp-inline.diff
}

platform darwin 11 {
   patchfiles-append	patch-fix-title-bar.diff patch-src_darwin.h.diff
   configure.cflags-append	-fno-pie -O2
   configure.ldflags-append	-fno-pie
}

post-patch {
    reinplace "s|__PREFIX__|${prefix}|" ${worksrcpath}/src/emacs.c
}

destroot {
        system "cd ${worksrcpath} && make install"
	xinstall -m 755 -d ${destroot}${applications_dir}
	file copy ${worksrcpath}/nextstep/Emacs.app \
		${destroot}${applications_dir}
	file copy ${filespath}/site-start.el \
		${destroot}${applications_dir}/Emacs.app/Contents/Resources/site-lisp
}

post-destroot {
	reinplace "s|__PREFIX__|${prefix}|g" \
		${destroot}${applications_dir}/Emacs.app/Contents/Resources/site-lisp/site-start.el
}
